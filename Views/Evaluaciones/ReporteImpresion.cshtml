@using EvaluacionDesempenoAB.ViewModels
@model EvaluacionReporteViewModel

@{
    Layout = null;
    var planAccion = Model.PlanAccion
        .Where(p => !string.IsNullOrWhiteSpace(p.Comportamiento) || !string.IsNullOrWhiteSpace(p.Descripcion))
        .ToList();
}
@functions {
    private (string Texto, string Clase) ObtenerNivelInfo(int? puntaje)
    {
        if (!puntaje.HasValue)
        {
            return ("Sin puntaje", "bg-secondary");
        }

        if (puntaje.Value <= 25)
        {
            return ("Nunca", "bg-danger");
        }

        if (puntaje.Value <= 50)
        {
            return ("Casi nunca", "bg-warning text-dark");
        }

        if (puntaje.Value <= 75)
        {
            return ("A veces", "bg-info text-dark");
        }

        if (puntaje.Value <= 90)
        {
            return ("Casi siempre", "bg-primary");
        }

        return ("Siempre", "bg-success");
    }
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reporte de evaluación</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <style>
        body {
            background: #ffffff;
            color: #1f1f1f;
            font-family: "Raleway", "Poppins", "Segoe UI", sans-serif;
            font-size: 12px;
        }

        .reporte-pdf {
            background: #ffffff;
            padding: 16px 18px 24px;
            border: 1px solid #444;
        }

        .firma-linea {
            border-top: 1px solid #212529;
            margin-top: 48px;
        }

        .firma-label {
            margin-top: 8px;
        }

        .tabla-compacta th,
        .tabla-compacta td {
            padding: 4px 6px;
        }

        .tabla-compacta th {
            background: #e6e6e6;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.2px;
        }

        .sheet-title {
            text-transform: uppercase;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
        }

        .sheet-header td,
        .sheet-header th {
            border: 1px solid #444;
            padding: 6px;
            vertical-align: middle;
        }

        .sheet-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sheet-table td,
        .sheet-table th {
            border: 1px solid #444;
        }

        .section-bar {
            background: #f08b3c;
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid #444;
        }

        .section-subtitle {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }

        .rating-cell {
            text-align: center;
            font-weight: 700;
            font-size: 11px;
        }

        .info-label {
            width: 32%;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            background: #f4f4f4;
        }

        .info-value {
            font-size: 11px;
        }

        .observaciones-box {
            min-height: 80px;
            padding: 8px;
        }

        .plan-table td {
            vertical-align: top;
        }

        .firmas-table td {
            height: 80px;
            text-align: center;
            vertical-align: bottom;
        }
    </style>
</head>
<body>
<div class="container my-4">
    <div id="reporte-imprimible" class="reporte-pdf shadow-sm">
        <table class="sheet-table sheet-header mb-3">
            <tr>
                <td style="width: 15%; text-align: center;">
                    <img src="~/img/LogoAB.png" alt="Logo AB" style="height: 36px;" />
                </td>
                <td style="width: 55%;">
                    <div class="sheet-title">Formato evaluación de desempeño</div>
                    <div class="sheet-title">@Model.NombreNivel</div>
                </td>
                <td style="width: 30%;">
                    <div><strong>Ficha:</strong> @Model.TipoEvaluacion</div>
                    <div><strong>Fecha:</strong> @Model.FechaEvaluacion.ToShortDateString()</div>
                </td>
            </tr>
        </table>

        <div class="section-bar">I. Identificación del colaborador</div>
        <table class="sheet-table tabla-compacta mb-3">
            <tr>
                <td class="info-label">Nombre completo</td>
                <td class="info-value">@Model.NombreUsuario</td>
            </tr>
            <tr>
                <td class="info-label">Cédula</td>
                <td class="info-value">@Model.CedulaUsuario</td>
            </tr>
            <tr>
                <td class="info-label">Cargo</td>
                <td class="info-value">@Model.Cargo</td>
            </tr>
            <tr>
                <td class="info-label">Gerencia</td>
                <td class="info-value">@Model.Gerencia</td>
            </tr>
            <tr>
                <td class="info-label">Nivel de evaluación</td>
                <td class="info-value">@Model.NombreNivel</td>
            </tr>
            <tr>
                <td class="info-label">Promedio general</td>
                <td class="info-value">
                    @if (Model.PromedioGeneral.HasValue)
                    {
                        @Model.PromedioGeneral.Value<span>%</span>
                    }
                    else
                    {
                        <span>No calculado</span>
                    }
                </td>
            </tr>
        </table>

        <div class="section-bar">II. Detalle por competencia</div>

        @foreach (var comp in Model.Competencias)
        {
            <div class="section-subtitle mt-3">@comp.Nombre</div>
            <table class="sheet-table tabla-compacta mb-2">
                <thead>
                    <tr>
                        <th style="width: 42%;">Comportamiento</th>
                        <th class="rating-cell" style="width: 9%;">Nunca</th>
                        <th class="rating-cell" style="width: 9%;">Casi nunca</th>
                        <th class="rating-cell" style="width: 9%;">A veces</th>
                        <th class="rating-cell" style="width: 9%;">Casi siempre</th>
                        <th class="rating-cell" style="width: 9%;">Siempre</th>
                        <th class="rating-cell" style="width: 13%;">Puntaje</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var c in comp.Comportamientos)
                {
                    var nivelInfo = ObtenerNivelInfo(c.Puntaje);
                    <tr>
                        <td>@c.Descripcion</td>
                        <td class="rating-cell">@(nivelInfo.Texto == "Nunca" ? "X" : "")</td>
                        <td class="rating-cell">@(nivelInfo.Texto == "Casi nunca" ? "X" : "")</td>
                        <td class="rating-cell">@(nivelInfo.Texto == "A veces" ? "X" : "")</td>
                        <td class="rating-cell">@(nivelInfo.Texto == "Casi siempre" ? "X" : "")</td>
                        <td class="rating-cell">@(nivelInfo.Texto == "Siempre" ? "X" : "")</td>
                        <td class="rating-cell">
                            @if (c.Puntaje.HasValue)
                            {
                                @c.Puntaje.Value<span>%</span>
                            }
                        </td>
                    </tr>
                }
                <tr>
                    <td colspan="6" class="info-label">Promedio de competencia</td>
                    <td class="rating-cell"><strong>@comp.Promedio %</strong></td>
                </tr>
                </tbody>
            </table>
        }

        <div class="section-bar mt-3">III. Oportunidades de mejora</div>

        @if (!Model.OportunidadesMejora.Any())
        {
            <div class="mt-2">No se identificaron comportamientos con puntajes por debajo del 76%.</div>
        }
        else
        {
            <table class="sheet-table tabla-compacta mt-2">
                <thead>
                    <tr>
                        <th>Competencia</th>
                        <th>Comportamiento</th>
                        <th style="width: 120px;">Puntaje</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var o in Model.OportunidadesMejora)
                {
                    <tr>
                        <td>@o.Competencia</td>
                        <td>@o.Comportamiento</td>
                        <td class="rating-cell">@o.Puntaje %</td>
                    </tr>
                }
                </tbody>
            </table>
        }

        @if (!string.IsNullOrWhiteSpace(Model.ObservacionesGenerales))
        {
            <div class="section-bar mt-3">IV. Observaciones generales</div>
            <table class="sheet-table tabla-compacta mt-2">
                <tr>
                    <td class="observaciones-box">@Model.ObservacionesGenerales</td>
                </tr>
            </table>
        }

        <div class="section-bar mt-3">V. Plan de acción</div>
        <div class="mt-2">Define el plan de acción a partir de los resultados de la evaluación y las oportunidades de mejora.</div>

        @if (!planAccion.Any())
        {
            <div class="mt-2">No hay plan de acción registrado.</div>
        }
        else
        {
            <table class="sheet-table tabla-compacta plan-table mt-2">
                <thead>
                    <tr>
                        <th style="width: 50%;">Oportunidad de mejora</th>
                        <th style="width: 50%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var plan in planAccion)
                {
                    <tr>
                        <td>@plan.Comportamiento</td>
                        <td>@plan.Descripcion</td>
                    </tr>
                }
                </tbody>
            </table>
        }

        <div class="section-bar mt-4">VI. Firmas</div>
        <table class="sheet-table firmas-table mt-2">
            <tr>
                <td style="width: 50%;">
                    <div class="firma-linea"></div>
                    <div class="firma-label">Firma del evaluador</div>
                </td>
                <td style="width: 50%;">
                    <div class="firma-linea"></div>
                    <div class="firma-label">Firma del usuario</div>
                </td>
            </tr>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-YcsIPGdhPK4P0H8JipdAEGZs4B/UXK5wLkMl1bDqLqngt/5qw+5mFZf2W8yI4KpGpkYp4a9p3KX8bfxiTltj/Q=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
<script>
    window.addEventListener("load", () => {
        const reporte = document.getElementById("reporte-imprimible");
        if (!reporte || typeof html2pdf === "undefined") {
            return;
        }

        const opciones = {
            margin: 0.3,
            filename: "reporte-evaluacion-@(Model.CedulaUsuario).pdf",
            html2canvas: { scale: 2 },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
        };

        html2pdf().set(opciones).from(reporte).save();
    });
</script>
</body>
</html>
