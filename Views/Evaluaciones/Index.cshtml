@using EvaluacionDesempenoAB.ViewModels
@model IEnumerable<EvaluacionListaViewModel>

@{
    ViewData["Title"] = "Mis evaluaciones";
}

<h2 class="mt-4">Mis evaluaciones</h2>

@if (!Model.Any())
{
    <div class="alert alert-info mt-3">
        No se han registrado evaluaciones aún.
    </div>
}
else
{
    <div class="d-flex flex-wrap gap-2 align-items-center mt-3"
         data-evaluaciones-acciones
         data-base-reporte="@Url.Action("Reporte", "Evaluaciones")"
         data-base-imprimir="@Url.Action("ImprimirResultados", "Evaluaciones")"
         data-base-reevaluar="@Url.Action("Reevaluar", "Evaluaciones")"
         data-base-carpeta="@Url.Action("Detalle", "Usuarios")">
        <span class="text-muted">Selecciona una evaluación para habilitar las acciones.</span>
        <a id="accionReporte"
           class="btn btn-sm btn-outline-primary disabled"
           href="#"
           aria-disabled="true">
            Ver reporte
        </a>
        <a id="accionImprimir"
           class="btn btn-sm btn-outline-success disabled"
           href="#"
           aria-disabled="true">
            Imprimir resultados
        </a>
        <a id="accionReevaluar"
           class="btn btn-sm btn-warning disabled"
           href="#"
           aria-disabled="true">
            Reevaluar
        </a>
        <a id="accionCarpeta"
           class="btn btn-sm btn-outline-secondary disabled"
           href="#"
           aria-disabled="true">
            Carpeta usuario
        </a>
    </div>
    <table class="table table-striped table-bordered mt-3">
        <thead class="table-light">
            <tr>
                <th style="width: 60px;">Seleccionar</th>
                <th>Fecha evaluación</th>
                <th>Próxima evaluación</th>
                <th>Nombre</th>
                <th>Cédula</th>
                <th>Nivel</th>
                <th>Tipo</th>
                 <th>Resultado final</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var e in Model.OrderByDescending(x => x.FechaEvaluacion))
        {
            <tr data-evaluacion-id="@e.Id"
                data-usuario-id="@e.UsuarioId"
                data-puede-reevaluar="@e.PuedeReevaluar.ToString().ToLower()">
                <td class="text-center">
                    <input type="radio"
                           name="evaluacionSeleccionada"
                           class="form-check-input"
                           aria-label="Seleccionar evaluación de @e.NombreUsuario" />
                </td>
                <td>@e.FechaEvaluacion.ToShortDateString()</td>
                <td>
                    @if (e.ProximaEvaluacion.HasValue)
                    {
                        @e.ProximaEvaluacion.Value.ToShortDateString()
                    }
                </td>
                <td>@e.NombreUsuario</td>
                <td>@e.CedulaUsuario</td>
                <td>
                    @e.NivelNombre
                    @if (!string.IsNullOrWhiteSpace(e.NivelCodigo))
                    {
                        <span class="badge bg-secondary ms-1">@e.NivelCodigo</span>
                    }
                </td>
                <td>@e.TipoEvaluacion</td>
                 <td>
                    @if (e.ResultadoFinal.HasValue)
                    {
                        @e.ResultadoFinal.Value.ToString("0.##")<span>%</span>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@section Scripts
{
    <script>
        (() => {
            const tabla = document.querySelector("table");
            const acciones = document.querySelector("[data-evaluaciones-acciones]");
            const accionReporte = document.getElementById("accionReporte");
            const accionImprimir = document.getElementById("accionImprimir");
            const accionReevaluar = document.getElementById("accionReevaluar");
            const accionCarpeta = document.getElementById("accionCarpeta");
            const baseReporte = acciones?.dataset.baseReporte ?? "";
            const baseImprimir = acciones?.dataset.baseImprimir ?? "";
            const baseReevaluar = acciones?.dataset.baseReevaluar ?? "";
            const baseCarpeta = acciones?.dataset.baseCarpeta ?? "";

            if (!tabla || !acciones) {
                return;
            }

            const setDisabled = (element, disabled) => {
                if (!element) {
                    return;
                }
                element.classList.toggle("disabled", disabled);
                element.setAttribute("aria-disabled", disabled ? "true" : "false");
                if (disabled) {
                    element.setAttribute("href", "#");
                }
            };

            const updateLinks = (row) => {
                if (!row) {
                    setDisabled(accionReporte, true);
                    setDisabled(accionImprimir, true);
                    setDisabled(accionReevaluar, true);
                    setDisabled(accionCarpeta, true);
                    return;
                }

                const evaluacionId = row.dataset.evaluacionId;
                const usuarioId = row.dataset.usuarioId;
                const puedeReevaluar = row.dataset.puedeReevaluar === "true";

                accionReporte.href = `${baseReporte}?id=${evaluacionId}`;
                accionImprimir.href = `${baseImprimir}?id=${evaluacionId}`;
                accionCarpeta.href = `${baseCarpeta}?id=${usuarioId}`;

                setDisabled(accionReporte, false);
                setDisabled(accionImprimir, false);
                setDisabled(accionCarpeta, false);
                setDisabled(accionReevaluar, !puedeReevaluar);

                if (puedeReevaluar) {
                    accionReevaluar.href = `${baseReevaluar}?id=${evaluacionId}`;
                }
            };

            tabla.addEventListener("change", (event) => {
                const input = event.target;
                if (!(input instanceof HTMLInputElement) || input.type !== "radio") {
                    return;
                }
                const row = input.closest("tr");
                updateLinks(row);
            });
        })();
    </script>
}
