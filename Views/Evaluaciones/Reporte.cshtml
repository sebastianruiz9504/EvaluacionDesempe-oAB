@using EvaluacionDesempenoAB.ViewModels
@model EvaluacionReporteViewModel

@{
    ViewData["Title"] = "Reporte de evaluación";
}

<div class="container mt-4">

    <h2>Reporte de evaluación de desempeño</h2>

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">@Model.NombreUsuario (@Model.CedulaUsuario)</h5>
            <p class="card-text mb-1">
                <strong>Cargo:</strong> @Model.Cargo
            </p>
            <p class="card-text mb-1">
                <strong>Gerencia:</strong> @Model.Gerencia
            </p>
            <p class="card-text mb-1">
                <strong>Nivel de evaluación:</strong> @Model.NombreNivel
            </p>
            <p class="card-text mb-1">
                <strong>Tipo de evaluación:</strong> @Model.TipoEvaluacion
            </p>
            <p class="card-text mb-1">
                <strong>Fecha de evaluación:</strong> @Model.FechaEvaluacion.ToShortDateString()
            </p>
            <p class="card-text">
                <strong>Promedio general:</strong>
                @if (Model.PromedioGeneral.HasValue)
                {
                    @Model.PromedioGeneral.Value<span>%</span>
                }
                else
                {
                    <span>No calculado</span>
                }
            </p>
        </div>
    </div>

    <h4 class="mt-4">Detalle por competencia</h4>

    @foreach (var comp in Model.Competencias)
    {
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><strong>@comp.Nombre</strong></span>
                <span>Promedio: @comp.Promedio %</span>
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Comportamiento</th>
                            <th style="width: 100px;">Puntaje</th>
                            <th>Comentario</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var c in comp.Comportamientos)
                    {
                        <tr class="@(c.Puntaje.HasValue && c.Puntaje.Value < 76 ? "table-warning" : "")">
                            <td>@c.Descripcion</td>
                            <td>
                                @if (c.Puntaje.HasValue)
                                {
                                    @c.Puntaje.Value<span>%</span>
                                }
                            </td>
                            <td>@c.Comentario</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <h4 class="mt-4">Oportunidades de mejora</h4>

    @if (!Model.OportunidadesMejora.Any())
    {
        <div class="alert alert-success mt-2">
            No se identificaron comportamientos con puntajes por debajo del 76%.
        </div>
    }
    else
    {
        <table class="table table-bordered mt-2">
            <thead class="table-light">
                <tr>
                    <th>Competencia</th>
                    <th>Comportamiento</th>
                    <th style="width: 120px;">Puntaje</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var o in Model.OportunidadesMejora)
            {
                <tr>
                    <td>@o.Competencia</td>
                    <td>@o.Comportamiento</td>
                    <td>@o.Puntaje %</td>
                </tr>
            }
            </tbody>
        </table>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ObservacionesGenerales))
    {
        <h4 class="mt-4">Observaciones generales</h4>
        <div class="card mt-2">
            <div class="card-body">
                @Model.ObservacionesGenerales
            </div>
        </div>
    }

    <h4 class="mt-4">Plan de acción</h4>

    <p>
        Define el plan de acción a partir de los resultados de la evaluación y las oportunidades de mejora.
    </p>

  @{
      var oportunidadesPorCompetencia = Model.OportunidadesMejora
            .GroupBy(o => o.Competencia)
            .OrderBy(g => g.Key)
            .ToList();

        var oportunidades = oportunidadesPorCompetencia
            .SelectMany(g => g.Select(o => o.Comportamiento))
            .Distinct()
            .ToList();
    }

    <form asp-action="GuardarPlanAccion" method="post" class="mt-2">
        @Html.AntiForgeryToken()

        <input asp-for="EvaluacionId" type="hidden" />

        <table class="table table-striped">
            <thead class="table-light">
                <tr>
                       <th style="width: 50%;">Oportunidad de mejora</th>
                    <th style="width: 50%;">Acciones</th>
                </tr>
            </thead>
             <tbody id="plan-accion-body">
            @for (int i = 0; i < Model.PlanAccion.Count; i++)
            {
                <tr>
                    <td>
                           <select asp-for="PlanAccion[@i].Comportamiento" class="form-select plan-accion-comportamiento">
                            <option value="">Seleccione una oportunidad</option>
                           @foreach (var grupo in oportunidadesPorCompetencia)
                            {
                                <optgroup label="@grupo.Key">
                                    @foreach (var oportunidad in grupo.Select(o => o.Comportamiento).Distinct().OrderBy(c => c))
                                    {
                                        <option value="@oportunidad"
                                                selected="@(Model.PlanAccion[i].Comportamiento == oportunidad ? "selected" : null)">
                                            @oportunidad
                                        </option>
                                    }
                                </optgroup>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.PlanAccion[i].Comportamiento) &&
                                 !oportunidades.Contains(Model.PlanAccion[i].Comportamiento))
                            {
                                <option value="@Model.PlanAccion[i].Comportamiento" selected="selected">
                                    @Model.PlanAccion[i].Comportamiento
                                </option>
                            }
                        </select>
                        <input asp-for="PlanAccion[@i].Id" type="hidden" />
                    </td>
                    <td>
                                      <textarea asp-for="PlanAccion[@i].Descripcion"
                                  class="form-control plan-accion-descripcion"
                                  maxlength="1000"
                                  rows="2"></textarea>
                    </td>
                </tr>
            }
            </tbody>
        </table>

       <div class="mt-3 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary" id="agregar-accion" disabled>
                Añadir otra oportunidad
            </button>
            <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#modalProximaEvaluacion">
                Guardar plan de acción
            </button>
            <a asp-action="Index" class="btn btn-secondary ms-2">
                Volver al listado
            </a>
        </div>

        <div class="modal fade" id="modalProximaEvaluacion" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Fecha estimada de reevaluación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label asp-for="FechaProximaEvaluacion" class="form-label">
                            Selecciona la fecha para reevaluar al usuario
                        </label>
                        <input asp-for="FechaProximaEvaluacion" type="date" class="form-control" required />
                        <span asp-validation-for="FechaProximaEvaluacion" class="text-danger"></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Confirmar y guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <template id="plan-accion-row-template">
        <tr>
            <td>
                <select name="PlanAccion[__index__].Comportamiento" class="form-select plan-accion-comportamiento">
                    <option value="">Seleccione una oportunidad</option>
                     @foreach (var grupo in oportunidadesPorCompetencia)
                    {
                        <optgroup label="@grupo.Key">
                            @foreach (var oportunidad in grupo.Select(o => o.Comportamiento).Distinct().OrderBy(c => c))
                            {
                                <option value="@oportunidad">@oportunidad</option>
                            }
                        </optgroup>
                    }
                </select>
                <input type="hidden" name="PlanAccion[__index__].Id" value="" />
            </td>
            <td>
                <textarea name="PlanAccion[__index__].Descripcion"
                          class="form-control plan-accion-descripcion"
                          maxlength="1000"
                          rows="2"></textarea>
            </td>
        </tr>
    </template>

    <script>
        (() => {
            const planBody = document.getElementById("plan-accion-body");
            const addButton = document.getElementById("agregar-accion");
            const rowTemplate = document.getElementById("plan-accion-row-template");
            let rowIndex = planBody ? planBody.children.length : 0;

            const hasOportunidades = @oportunidades.Any().ToString().ToLower();

            const updateAddButtonState = () => {
                if (!addButton || !planBody) {
                    return;
                }

                if (!hasOportunidades) {
                    addButton.disabled = true;
                    return;
                }

                const rows = planBody.querySelectorAll("tr");
                if (rows.length === 0) {
                    addButton.disabled = false;
                    return;
                }

                const lastSelect = rows[rows.length - 1].querySelector(".plan-accion-comportamiento");
                addButton.disabled = !lastSelect || !lastSelect.value;
            };

            const addRow = () => {
                if (!rowTemplate || !planBody) {
                    return;
                }

                const html = rowTemplate.innerHTML.replace(/__index__/g, rowIndex);
                planBody.insertAdjacentHTML("beforeend", html);
                rowIndex += 1;
                updateAddButtonState();
            };

            if (planBody) {
                planBody.addEventListener("change", (event) => {
                    if (event.target instanceof HTMLSelectElement &&
                        event.target.classList.contains("plan-accion-comportamiento")) {
                        updateAddButtonState();
                    }
                });
            }

            if (addButton) {
                addButton.addEventListener("click", () => {
                    addRow();
                });
            }

            updateAddButtonState();
        })();
    </script>
</div>